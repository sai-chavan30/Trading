<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“ˆ Top Movers Dashboard</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    body { background:#f8f9fa; }
    .container { margin-top:30px; }
    table th, table td { text-align:center; vertical-align:middle; }
    .gain { color:green; font-weight:bold; }
    .loss { color:red; font-weight:bold; }
    .trade-buy { color:green; font-weight:bold; }
    .trade-sell { color:red; font-weight:bold; }
    .card { box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { font-weight:700; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">ðŸ“Š Real-Time Stock Movers & Trade Dashboard</h1>
    <div class="row">
      <!-- LEFT SIDE: Gainers -->
      <div class="col-md-8">
        <div class="card p-3 mb-4">
          <h3 class="mb-3">ðŸ”¥ Top 20 Live Movers</h3>
          <table class="table table-bordered table-striped bg-white">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Symbol</th>
                <th>Name</th>
                <th>Price ($)</th>
                <th>Change %</th>
              </tr>
            </thead>
            <tbody id="gainersTable">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT SIDE: Trades -->
      <div class="col-md-4">
        <div class="card p-3 mb-4">
          <h3 class="mb-3">ðŸ’° Profit / Loss</h3>
          <div id="profitLossPanel">Loading...</div>
        </div>

        <div class="card p-3">
          <h4 class="mb-3">ðŸ§¾ Trade Log</h4>
          <table class="table table-bordered table-striped bg-white">
            <thead class="table-dark">
              <tr>
                <th>Time</th>
                <th>Symbol</th>
                <th>Type</th>
                <th>Qty</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody id="tradesTable">
              <tr><td colspan="5">Waiting for trades...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- SOCKET.IO -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io();

    // ---- Gainers update ----
    socket.on('update_gainers', (data) => {
      const tbody = document.getElementById("gainersTable");
      tbody.innerHTML = "";
      data.slice(0, 20).forEach((s, i) => {
        const cls = s.changePercent >= 0 ? "gain" : "loss";
        tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${s.symbol}</td>
            <td>${s.name}</td>
            <td>$${(s.price || 0).toFixed(2)}</td>
            <td class="${cls}">${(s.changePercent || 0).toFixed(2)}%</td>
          </tr>`;
      });
    });

    // ---- Trade / Profit update ----
    socket.on('update_trades', (stats) => {
      // Profit panel
      document.getElementById("profitLossPanel").innerHTML = `
        <div>
          <b>Total Profit/Loss:</b>
          <span class="${stats.total_profit >= 0 ? "gain" : "loss"}">
            $${Number(stats.total_profit).toFixed(2)}
          </span>
        </div>
        <div class="mt-2">
          <b>Open Positions:</b>
          <ul class="mb-0">
            ${Object.entries(stats.open_positions || {})
              .map(([sym, pos]) =>
                `<li>${sym}: <b>${pos.qty}</b> @ avg $${Number(pos.avg_price).toFixed(2)}</li>`
              )
              .join("")}
          </ul>
        </div>`;

      // Trade table
      const tbody = document.getElementById("tradesTable");
      tbody.innerHTML = "";
      (stats.trades || []).slice().reverse().forEach((tr) => {
        tbody.innerHTML += `
          <tr>
            <td>${tr.time}</td>
            <td>${tr.symbol}</td>
            <td class="trade-${tr.type}">${tr.type.toUpperCase()}</td>
            <td>${tr.qty}</td>
            <td>$${Number(tr.price).toFixed(2)}</td>
          </tr>`;
      });
    });

    // ---- Fallback (initial data load via REST) ----
    async function loadInitial() {
      try {
        const g = await fetch("/api/gainers");
        const t = await fetch("/api/trades");
        const gainers = await g.json();
        const trades = await t.json();
        socket.emit('update_gainers', gainers);
        socket.emit('update_trades', trades);
      } catch (e) {
        console.error("Initial data fetch failed:", e);
      }
    }

    loadInitial();
  </script>
</body>
</html>
